<%= form_for(@article) do |f| %>
  <% if @article.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@article.errors.count, "error") %> prohibited this article from being saved:</h2>

      <ul>
        <% @article.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= f.label :title %><br>
    <%= f.text_field :title %>
  </div>
  <div class="field">
    <%= f.label :content %><br>
    <%= f.text_area :content %>
  </div>

  <div>
    <ul id="attachments"></ul>
  </div>

  <div>
    <p>
      <a href="#" id="attach_image">Attach Image</a>
    </p>

    <p>
      <a href="#" id="attach_file">Attach File</a>
    </p>

  </div>

  <div class="actions">
    <%= f.submit %>
  </div>
<% end %>

<script>

  function delete_attachment(attachment_id){
    var callback = function(data){
      $("#attachment-"+data.id).remove();
    };

    if (confirm("Are you sure?")) {
      $.post('/attachments/' + attachment_id, {_method:'delete'}, callback, "json");
    } else {
      console.error('error');
    }

  }

  function ready() {


    CKEDITOR.timestamp = +new Date;
    CKEDITOR.plugins.addExternal('ckeditor-attachments', '/ckeditor/plugins/ckeditor-attachments/', 'plugin.js');
    var ref = CKEDITOR.tools.addFunction(function(attachment_id, filename){
//      console.log(attachment_id)
//      console.log(filename)
      $("#attachments").append("<li id='attachment-"+attachment_id+"'><i class='fa fa-paperclip'></i>" + filename +
        "<a href='#' onclick='delete_attachment("+attachment_id+")'><i class='fa fa-trash-o'></i></a></li>");
    });


    CKEDITOR.replace('article_content', {
      customConfig: '/ckeditor/config.js',
      filebrowserUploadUrl: "/attachments?article_uuid=<%= @article.uuid %>&callback="+ref
    });

    $("#attach_image").click(function () {
      CKEDITOR.instances.article_content.openDialog('ckeditor-attachments');
      CKEDITOR.instances.article_content.execCommand('openAttachmentDialog');
    });
  }

  CKEDITOR.add_attachment = function(filename){
    $("#attachments").append("<li>" + filename + "</li>");
  };

  $(document).ready(ready);
  $(document).on('page:load', ready);


</script>